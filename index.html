
  <!DOCTYPE html>
  <html lang="en">
    <head>
     <script src="https://telegram.org/js/telegram-web-app.js"></script>
      <meta charset="UTF-8" />
      <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <title>Макет приложения для Telegram (Copy) (Copy)</title>
    </head>

   <script>
(function () {
  const API_BASE =
    (window?.import?.meta && window.import.meta.env?.VITE_API_BASE_URL) ||
    window.VITE_API_BASE_URL ||
    "https://hui-production.up.railway.app";

  const LS_TOKEN_KEY = "grither_admin_token";
  const LS_ROLE_KEY  = "grither_admin_role";
  const LS_AUTOGO    = "grither_admin_autogo";

  // ── 0) Автопереход в админку после перезагрузки
  function tryOpenAdminTab() {
    // 1) пробуем через hash
    try { if (!location.hash || !/#admin/i.test(location.hash)) location.hash = "#admin"; } catch {}
    // 2) пробуем кликнуть по элементам с текстом «Админ»
    const candidates = [
      ...document.querySelectorAll('a,button,[role="button"],[data-route],[data-tab]')
    ].filter(el => /админ|admin/i.test((el.innerText || el.getAttribute?.("aria-label") || el.getAttribute?.("title") || "").trim()));
    if (candidates[0]) { try { candidates[0].click(); } catch {} }
    // 3) шлём событие (если приложение его слушает)
    try { window.dispatchEvent(new CustomEvent("grither:goto-admin")); } catch {}
  }

  function scheduleAutoGoIfNeeded() {
    try {
      const token = localStorage.getItem(LS_TOKEN_KEY);
      const auto  = localStorage.getItem(LS_AUTOGO) === "1";
      if (!token || !auto) return;
      // несколько попыток в течение 2 сек (пока приложение монтируется)
      const started = Date.now();
      const timer = setInterval(() => {
        tryOpenAdminTab();
        if (Date.now() - started > 2000) {
          clearInterval(timer);
          localStorage.removeItem(LS_AUTOGO);
        }
      }, 200);
      // если получится раньше — снимаем флаг через 1 сек
      setTimeout(() => localStorage.removeItem(LS_AUTOGO), 1200);
    } catch {}
  }

  if (document.readyState === "complete" || document.readyState === "interactive") {
    scheduleAutoGoIfNeeded();
  } else {
    window.addEventListener("DOMContentLoaded", scheduleAutoGoIfNeeded);
  }

  // ── 1) Блокируем старый alert «Неверный код доступа»
  const nativeAlert = window.alert;
  window.alert = function (msg) {
    try {
      if (typeof msg === "string" && /неверн(ый|ая).*(код|доступ)/i.test(msg)) {
        console.warn("[admin] blocked legacy alert:", msg);
        return;
      }
    } catch {}
    return nativeAlert.apply(this, arguments);
  };

  // ── 2) Поиск элементов в модалке
  function findEls(root) {
    const idInput =
      root.querySelector('input[type="number"]') ||
      [...root.querySelectorAll('input,textarea')].find(el =>
        /telegram\s*id|^id$/i.test(el.placeholder || el.ariaLabel || el.name || el.id || "")
      );

    const passInput =
      root.querySelector('input[type="password"]') ||
      [...root.querySelectorAll('input,textarea')].find(el =>
        /(парол|password|код\s*доступа)/i.test(el.placeholder || el.ariaLabel || el.name || el.id || "")
      );

    const loginBtn =
      [...root.querySelectorAll('button,[role="button"],input[type="submit"]')].find(el =>
        /(войти\s*в\s*админку|войти|login)/i.test((el.innerText || el.value || "").trim())
      );

    let errorBox =
      root.querySelector('[data-admin-error]') ||
      [...root.querySelectorAll('*')].find(el => /error|ошиб/i.test(el.className || el.id || ""));
    if (!errorBox && loginBtn && loginBtn.parentElement) {
      errorBox = document.createElement("div");
      errorBox.setAttribute("data-admin-error", "1");
      errorBox.style.cssText = "color:#ff6b6b;font-size:12px;margin-top:8px;";
      loginBtn.parentElement.appendChild(errorBox);
    }
    return { idInput, passInput, loginBtn, errorBox };
  }

  // ── 3) Логин на бэк
  async function doLogin(modalRoot, idInput, passInput, errorBox, btn) {
    if (errorBox) { errorBox.style.color = "#ff6b6b"; errorBox.textContent = ""; }

    const idNum = Number(String(idInput?.value ?? "").trim());
    const pwd   = String(passInput?.value ?? "").trim();
    if (!idNum || !pwd) {
      if (errorBox) errorBox.textContent = "Введите Telegram ID и пароль";
      return;
    }

    try {
      const rsp = await fetch(`${API_BASE}/api/admin/login`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ tg_user_id: idNum, password: pwd })
      });
      const data = await rsp.json().catch(() => ({}));
      if (!rsp.ok || !data?.ok) {
        if (errorBox) errorBox.textContent =
          data?.error === "bad_credentials" ? "Неверный ID или пароль" : "Ошибка входа";
        return;
      }

      // успех: сохраняем токен/роль и ставим флажок автоперехода
      localStorage.setItem(LS_TOKEN_KEY, data.token);
      localStorage.setItem(LS_ROLE_KEY,  data.role);
      localStorage.setItem(LS_AUTOGO,   "1");
      if (errorBox) { errorBox.style.color = "#0a7c2f"; errorBox.textContent = "Вход выполнен. Роль: " + data.role; }

      // закрыть модалку
      try {
        const closeBtn =
          modalRoot?.querySelector('[aria-label="Close"], [data-dialog-close], .close, [data-state="open"]~button');
        closeBtn && closeBtn.click();
      } catch {}
      try { modalRoot?.remove(); } catch {}
      try {
        document.querySelectorAll('dialog[open], [role="dialog"], .modal, .overlay').forEach(el => {
          try { if (btn && el.contains(btn)) el.remove(); } catch {}
        });
      } catch {}

      // событие + перезагрузка
      try { window.dispatchEvent(new CustomEvent("grither:admin:login", { detail: { role: data.role } })); } catch {}
      setTimeout(() => location.reload(), 600);
    } catch {
      if (errorBox) errorBox.textContent = "Сеть недоступна";
    }
  }

  // ── 4) Жёсткий перехват клика по кнопке «Войти» (раньше Фигмы)
  document.addEventListener("click", function onDocClick(e) {
    const target = e.target;
    if (!(target instanceof HTMLElement)) return;

    const modalRoot = target.closest('dialog,[role="dialog"],[data-state="open"],.modal,.overlay,.fixed') || document.body;
    const { idInput, passInput, loginBtn, errorBox } = findEls(modalRoot);
    if (!loginBtn) return;

    const isLoginBtn = target === loginBtn || loginBtn.contains(target);
    if (!isLoginBtn) return;

    e.preventDefault(); e.stopPropagation(); e.stopImmediatePropagation();
    try { loginBtn.removeAttribute("disabled"); loginBtn.removeAttribute("aria-disabled"); loginBtn.style.pointerEvents = "auto"; loginBtn.style.opacity = ""; } catch {}
    doLogin(modalRoot, idInput, passInput, errorBox, loginBtn);
  }, true);

  // ── 5) Перехват Enter в поле пароля
  document.addEventListener("keydown", function onKey(e) {
    if (e.key !== "Enter") return;
    const active = document.activeElement;
    if (!(active instanceof HTMLElement)) return;
    const modalRoot = active.closest('dialog,[role="dialog"],[data-state="open"],.modal,.overlay,.fixed');
    if (!modalRoot) return;

    const { idInput, passInput, loginBtn, errorBox } = findEls(modalRoot);
    if (!passInput || active !== passInput) return;
    e.preventDefault(); e.stopPropagation(); e.stopImmediatePropagation();
    doLogin(modalRoot, idInput, passInput, errorBox, loginBtn);
  }, true);
})();
</script>




    
    <body>
      <div id="root"></div>
     <!-- Авто-авторизация в Telegram WebApp -->
    <!-- Диагностический маяк + авторизация через Telegram WebApp (с фолбэком) -->
<script>
(function () {
  // 0) Маяк: загрузка страницы
  new Image().src = 'https://hui-production.up.railway.app/api/twa/ping?from=indexhtml&ts=' + Date.now();

  try {
    var wa = window.Telegram && Telegram.WebApp;
    new Image().src = 'https://hui-production.up.railway.app/api/twa/ping?wa=' + (wa ? 1 : 0);
    if (!wa) return;

    // чуть «раскрываем» WebApp и помечаем готовность
    try { wa.ready(); wa.expand(); } catch (e) {}

    // 1) если есть «настоящий» initData — используем его
    var hasInit = !!(wa.initData && wa.initData.length > 10);
    new Image().src = 'https://hui-production.up.railway.app/api/twa/ping?init=' + (hasInit ? 1 : 0);

    // 2) если initData пуст, соберём фолбэк из initDataUnsafe.user (это ок, пока SKIP_TWA_VERIFY=1 на бэке)
    var initDataToSend;
    if (hasInit) {
      initDataToSend = wa.initData;
    } else {
      var unsafeUser = (wa.initDataUnsafe && wa.initDataUnsafe.user) || null;
      if (!unsafeUser) return; // вообще нет данных — выходим
      var u = encodeURIComponent(JSON.stringify(unsafeUser));
      // формируем "псевдо-initData" (хеш фиктивный — в diag-режиме сервер примет)
      initDataToSend = 'query_id=x&user=' + u + '&auth_date=0&hash=0';
    }

  
    .then(function(r){ return r.json(); })
    .then(function(r){
      new Image().src = 'https://hui-production.up.railway.app/api/twa/ping?auth=' + (r && r.ok ? 'ok' : 'fail');
      if (r && r.ok) {
        localStorage.setItem('grither_token', r.token || '');
        localStorage.setItem('grither_me', JSON.stringify(r.me || {}));
      }
    })
    .catch(function(){ /* ignore */ });

  } catch (e) {
    new Image().src = 'https://hui-production.up.railway.app/api/twa/ping?err=1';
  }
})();
</script>


<script>
(function () {
  try {
    var wa = window.Telegram && Telegram.WebApp;
    if (!wa || !wa.initData) return; // если открыто НЕ из Telegram — тихо выходим

    // ПИНГ ДЛЯ ПРОВЕРКИ СВЯЗИ (увидишь в HTTP Logs)
    fetch('https://hui-production.up.railway.app/api/twa/ping?from=netlify-indexhtml')
      .catch(function(){});

    // Сама авторизация
    fetch('https://hui-production.up.railway.app/api/twa/auth', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ initData: wa.initData })
    })
      .then(function(r){ return r.json(); })
      .then(function(r){
        // чтобы видеть прямо в вебвью
        try { console.log('AUTH RESULT', r); } catch(e) {}
        if (r && r.ok) {
          localStorage.setItem('grither_token', r.token || '');
          localStorage.setItem('grither_me', JSON.stringify(r.me || {}));
        }
      })
      .catch(function(){});
  } catch (e) {
    try { console.log('AUTH ERROR', e && e.message); } catch (_){}
  }
})();
</script>

      <script type="module" src="/src/main.tsx"></script>
    </body>
  </html>
  
